"use client"

import { useEffect, useRef } from "react"

// ==========================================
// ğŸ¨ ãƒ‰ãƒƒãƒˆãƒãƒˆãƒªã‚¯ã‚¹è¡¨ç¤ºé ˜åŸŸã®è¨­å®š (DOT_MATRIX_CONFIG)
// ==========================================
// ã“ã“ã§ä½ç½®ã€ã‚µã‚¤ã‚ºã€è‰²ã€ãƒ‰ãƒƒãƒˆã®å½¢çŠ¶ãªã©ã‚’è‡ªç”±ã«èª¿æ•´ã§ãã¾ã™ã€‚
export const DOT_MATRIX_CONFIG = {
  position: { x: 542.7, y: 96.8 }, // (x, y) = ãƒ‰ãƒƒãƒˆãƒãƒˆãƒªã‚¯ã‚¹å…¨ä½“ã®å·¦ä¸‹ã®åº§æ¨™

  // ã‚»ãƒ«ï¼ˆ1æ–‡å­—åˆ†ï¼‰ã®è¨­å®š
  rows: 7, // ç¸¦ã®ãƒ‰ãƒƒãƒˆæ•°
  cols: 5, // æ¨ªã®ãƒ‰ãƒƒãƒˆæ•°
  numCells: 12, // ã‚»ãƒ«ï¼ˆæ–‡å­—ï¼‰ã®æ•°

  pixel: {
    width: 5.7, // ãƒ”ã‚¯ã‚»ãƒ«ã®æ¨ªå¹…
    height: 9, // ãƒ”ã‚¯ã‚»ãƒ«ã®ç¸¦å¹…
    slantLR: 3, // å·¦å³ã®å‚¾æ–œï¼ˆå¹³è¡Œå››è¾ºå½¢ã®å¤‰å½¢ï¼šä¸Šã«ã„ãã»ã©å³ã«ãšã‚Œã‚‹é‡ï¼‰
    slopeTB: 0.0, // ä¸Šä¸‹ã®å‚¾æ–œï¼ˆå¹³è¡Œå››è¾ºå½¢ã®å¤‰å½¢ï¼šå³ã«ã„ãã»ã©ä¸Šã«ä¸ŠãŒã‚‹é‡ï¼‰
    stackSlant: 4.3, // ç©ã¿ä¸Šã’æ™‚ã®å‚¾æ–œï¼ˆä¸Šã®è¡Œã»ã©å³ã«ãšã‚‰ã™é‡ï¼‰
  },

  // ãƒ”ã‚¯ã‚»ãƒ«é–“ã®éš™é–“
  dotGapX: 3.65, // ãƒ‰ãƒƒãƒˆé–“ã®æ¨ªã®éš™é–“
  dotGapY: 4.45, // ãƒ‰ãƒƒãƒˆé–“ã®ç¸¦ã®éš™é–“
  cellGap: 25, // ã‚»ãƒ«ï¼ˆæ–‡å­—ï¼‰é–“ã®éš™é–“

  // è¦‹ãŸç›®ã®è¨­å®š
  color: "#b0f5ffff", // ãƒ‰ãƒƒãƒˆã®è‰²
  offColor: "#231e2dff", // æ¶ˆç¯æ™‚ã®ãƒ‰ãƒƒãƒˆã®è‰²
  glowBlur: 0, // ç™ºå…‰ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã®å¼·ã•

  // ãƒ‡ãƒãƒƒã‚°ç”¨: å…¨ç‚¹ç¯ã•ã›ã‚‹ã‹ã©ã†ã‹
  debugAllOn: false,
}

// 5x7 dot patterns. 1 is on, 0 is off.
// Each array represents rows from top to bottom.
export const CHAR_PATTERNS: Record<string, number[][]> = {
  '0': [
    [0,1,1,1,0],
    [1,0,0,0,1],
    [1,0,0,1,1],
    [1,0,1,0,1],
    [1,1,0,0,1],
    [1,0,0,0,1],
    [0,1,1,1,0]
  ],
  '1': [
    [0,0,1,0,0],
    [0,1,1,0,0],
    [0,0,1,0,0],
    [0,0,1,0,0],
    [0,0,1,0,0],
    [0,0,1,0,0],
    [0,1,1,1,0]
  ],
  '2': [
    [0,1,1,1,0],
    [1,0,0,0,1],
    [0,0,0,0,1],
    [0,0,0,1,0],
    [0,0,1,0,0],
    [0,1,0,0,0],
    [1,1,1,1,1]
  ],
  '3': [
    [1,1,1,1,1],
    [0,0,0,1,0],
    [0,0,1,0,0],
    [0,0,0,1,0],
    [0,0,0,0,1],
    [1,0,0,0,1],
    [0,1,1,1,0]
  ],
  '4': [
    [0,0,0,1,0],
    [0,0,1,1,0],
    [0,1,0,1,0],
    [1,0,0,1,0],
    [1,1,1,1,1],
    [0,0,0,1,0],
    [0,0,0,1,0]
  ],
  '5': [
    [1,1,1,1,1],
    [1,0,0,0,0],
    [1,1,1,1,0],
    [0,0,0,0,1],
    [0,0,0,0,1],
    [1,0,0,0,1],
    [0,1,1,1,0]
  ],
  '6': [
    [0,0,1,1,0],
    [0,1,0,0,0],
    [1,0,0,0,0],
    [1,1,1,1,0],
    [1,0,0,0,1],
    [1,0,0,0,1],
    [0,1,1,1,0]
  ],
  '7': [
    [1,1,1,1,1],
    [0,0,0,0,1],
    [0,0,0,1,0],
    [0,0,1,0,0],
    [0,1,0,0,0],
    [0,1,0,0,0],
    [0,1,0,0,0]
  ],
  '8': [
    [0,1,1,1,0],
    [1,0,0,0,1],
    [1,0,0,0,1],
    [0,1,1,1,0],
    [1,0,0,0,1],
    [1,0,0,0,1],
    [0,1,1,1,0]
  ],
  '9': [
    [0,1,1,1,0],
    [1,0,0,0,1],
    [1,0,0,0,1],
    [0,1,1,1,1],
    [0,0,0,0,1],
    [0,0,0,1,0],
    [0,1,1,0,0]
  ],
  'A': [
    [0,1,1,1,0],
    [1,0,0,0,1],
    [1,0,0,0,1],
    [1,0,0,0,1],
    [1,1,1,1,1],
    [1,0,0,0,1],
    [1,0,0,0,1]
  ],
  'B': [
    [1,1,1,1,0],
    [1,0,0,0,1],
    [1,0,0,0,1],
    [1,1,1,1,0],
    [1,0,0,0,1],
    [1,0,0,0,1],
    [1,1,1,1,0]
  ],
  'C': [
    [0,1,1,1,0],
    [1,0,0,0,1],
    [1,0,0,0,0],
    [1,0,0,0,0],
    [1,0,0,0,0],
    [1,0,0,0,1],
    [0,1,1,1,0]
  ],
  'D': [
    [1,1,1,0,0],
    [1,0,0,1,0],
    [1,0,0,0,1],
    [1,0,0,0,1],
    [1,0,0,0,1],
    [1,0,0,1,0],
    [1,1,1,0,0]
  ],
  'E': [
    [1,1,1,1,1],
    [1,0,0,0,0],
    [1,0,0,0,0],
    [1,1,1,1,0],
    [1,0,0,0,0],
    [1,0,0,0,0],
    [1,1,1,1,1]
  ],
  'F': [
    [1,1,1,1,1],
    [1,0,0,0,0],
    [1,0,0,0,0],
    [1,1,1,1,0],
    [1,0,0,0,0],
    [1,0,0,0,0],
    [1,0,0,0,0]
  ],
  'G': [
    [0,1,1,1,0],
    [1,0,0,0,1],
    [1,0,0,0,0],
    [1,0,1,1,1],
    [1,0,0,0,1],
    [1,0,0,0,1],
    [0,1,1,1,0]
  ],
  'H': [
    [1,0,0,0,1],
    [1,0,0,0,1],
    [1,0,0,0,1],
    [1,1,1,1,1],
    [1,0,0,0,1],
    [1,0,0,0,1],
    [1,0,0,0,1]
  ],
  'I': [
    [0,1,1,1,0],
    [0,0,1,0,0],
    [0,0,1,0,0],
    [0,0,1,0,0],
    [0,0,1,0,0],
    [0,0,1,0,0],
    [0,1,1,1,0]
  ],
  'J': [
    [0,0,1,1,1],
    [0,0,0,1,0],
    [0,0,0,1,0],
    [0,0,0,1,0],
    [0,0,0,1,0],
    [1,0,0,1,0],
    [0,1,1,0,0]
  ],
  'K': [
    [1,0,0,0,1],
    [1,0,0,1,0],
    [1,0,1,0,0],
    [1,1,0,0,0],
    [1,0,1,0,0],
    [1,0,0,1,0],
    [1,0,0,0,1]
  ],
  'L': [
    [1,0,0,0,0],
    [1,0,0,0,0],
    [1,0,0,0,0],
    [1,0,0,0,0],
    [1,0,0,0,0],
    [1,0,0,0,0],
    [1,1,1,1,1]
  ],
  'M': [
    [1,0,0,0,1],
    [1,1,0,1,1],
    [1,0,1,0,1],
    [1,0,1,0,1],
    [1,0,0,0,1],
    [1,0,0,0,1],
    [1,0,0,0,1]
  ],
  'N': [
    [1,0,0,0,1],
    [1,0,0,0,1],
    [1,1,0,0,1],
    [1,0,1,0,1],
    [1,0,0,1,1],
    [1,0,0,0,1],
    [1,0,0,0,1]
  ],
  'O': [
    [0,1,1,1,0],
    [1,0,0,0,1],
    [1,0,0,0,1],
    [1,0,0,0,1],
    [1,0,0,0,1],
    [1,0,0,0,1],
    [0,1,1,1,0]
  ],
  'P': [
    [1,1,1,1,0],
    [1,0,0,0,1],
    [1,0,0,0,1],
    [1,1,1,1,0],
    [1,0,0,0,0],
    [1,0,0,0,0],
    [1,0,0,0,0]
  ],
  'Q': [
    [0,1,1,1,0],
    [1,0,0,0,1],
    [1,0,0,0,1],
    [1,0,0,0,1],
    [1,0,1,0,1],
    [1,0,0,1,0],
    [0,1,1,0,1]
  ],
  'R': [
    [1,1,1,1,0],
    [1,0,0,0,1],
    [1,0,0,0,1],
    [1,1,1,1,0],
    [1,0,1,0,0],
    [1,0,0,1,0],
    [1,0,0,0,1]
  ],
  'S': [
    [0,1,1,1,1],
    [1,0,0,0,0],
    [1,0,0,0,0],
    [0,1,1,1,0],
    [0,0,0,0,1],
    [0,0,0,0,1],
    [1,1,1,1,0]
  ],
  'T': [
    [1,1,1,1,1],
    [0,0,1,0,0],
    [0,0,1,0,0],
    [0,0,1,0,0],
    [0,0,1,0,0],
    [0,0,1,0,0],
    [0,0,1,0,0]
  ],
  'U': [
    [1,0,0,0,1],
    [1,0,0,0,1],
    [1,0,0,0,1],
    [1,0,0,0,1],
    [1,0,0,0,1],
    [1,0,0,0,1],
    [0,1,1,1,0]
  ],
  'V': [
    [1,0,0,0,1],
    [1,0,0,0,1],
    [1,0,0,0,1],
    [1,0,0,0,1],
    [1,0,0,0,1],
    [0,1,0,1,0],
    [0,0,1,0,0]
  ],
  'W': [
    [1,0,0,0,1],
    [1,0,0,0,1],
    [1,0,0,0,1],
    [1,0,1,0,1],
    [1,0,1,0,1],
    [1,0,1,0,1],
    [0,1,0,1,0]
  ],
  'X': [
    [1,0,0,0,1],
    [1,0,0,0,1],
    [0,1,0,1,0],
    [0,0,1,0,0],
    [0,1,0,1,0],
    [1,0,0,0,1],
    [1,0,0,0,1]
  ],
  'Y': [
    [1,0,0,0,1],
    [1,0,0,0,1],
    [1,0,0,0,1],
    [0,1,0,1,0],
    [0,0,1,0,0],
    [0,0,1,0,0],
    [0,0,1,0,0]
  ],
  'Z': [
    [1,1,1,1,1],
    [0,0,0,0,1],
    [0,0,0,1,0],
    [0,0,1,0,0],
    [0,1,0,0,0],
    [1,0,0,0,0],
    [1,1,1,1,1]
  ],
  ' ': [
    [0,0,0,0,0],
    [0,0,0,0,0],
    [0,0,0,0,0],
    [0,0,0,0,0],
    [0,0,0,0,0],
    [0,0,0,0,0],
    [0,0,0,0,0]
  ],
  '/': [
    [0,0,0,0,0],
    [0,0,0,0,1],
    [0,0,0,1,0],
    [0,0,1,0,0],
    [0,1,0,0,0],
    [1,0,0,0,0],
    [0,0,0,0,0]
  ],
  '-': [
    [0,0,0,0,0],
    [0,0,0,0,0],
    [0,0,0,0,0],
    [1,1,1,1,1],
    [0,0,0,0,0],
    [0,0,0,0,0],
    [0,0,0,0,0]
  ]
}

interface DotMatrixDisplayProps {
  width?: number
  height?: number
  className?: string
  text?: string // Added text prop
}

export function DotMatrixDisplay({ width = 600, height = 100, className, text = "QGW" }: DotMatrixDisplayProps) {
  const canvasRef = useRef<HTMLCanvasElement>(null)

  useEffect(() => {
    const canvas = canvasRef.current
    if (!canvas) return

    const ctx = canvas.getContext("2d")
    if (!ctx) return

    // æç”»ãƒ«ãƒ¼ãƒ—
    let animationFrameId: number

    const render = () => {
      // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ã‚¯ãƒªã‚¢
      ctx.clearRect(0, 0, canvas.width, canvas.height)

      // è¨­å®šã®èª­ã¿è¾¼ã¿
      const {
        position,
        rows,
        cols,
        numCells,
        pixel,
        dotGapX,
        dotGapY,
        cellGap,
        color,
        offColor,
        glowBlur,
        debugAllOn,
      } = DOT_MATRIX_CONFIG

      ctx.shadowBlur = glowBlur
      ctx.shadowColor = color

      const cellWidth = cols * (pixel.width + dotGapX) - dotGapX
      const totalHeight = rows * (pixel.height + dotGapY) - dotGapY
      
      // å…¨ã‚»ãƒ«ã‚’æç”»
      for (let cellIndex = 0; cellIndex < numCells; cellIndex++) {
        const cellStartX = position.x + cellIndex * (cellWidth + cellGap)
        const cellStartY = position.y - totalHeight

        // ã‚»ãƒ«å†…ã®ãƒ‰ãƒƒãƒˆã‚’æç”» (5x7)
        for (let r = 0; r < rows; r++) {
          // ä¸‹ã‹ã‚‰ã®è¡Œã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆ0å§‹ã¾ã‚Šï¼‰ã‚’è¨ˆç®—
          // r=0ãŒä¸€ç•ªä¸Šã€r=rows-1ãŒä¸€ç•ªä¸‹ãªã®ã§åè»¢ã•ã›ã‚‹
          const rowIndexFromBottom = rows - 1 - r
          
          // stackSlantã«ã‚ˆã‚‹Xåº§æ¨™ã®ã‚ºãƒ¬ã‚’è¨ˆç®—ï¼ˆä¸Šã«ã„ãã»ã©å³ã«ãšã‚Œã‚‹ï¼‰
          const stackShift = rowIndexFromBottom * pixel.stackSlant

          for (let c = 0; c < cols; c++) {
            const x = cellStartX + c * (pixel.width + dotGapX) + stackShift
            const y = cellStartY + r * (pixel.height + dotGapY)

            // ç‚¹ç¯çŠ¶æ…‹ã®åˆ¤å®š (ç¾åœ¨ã¯ãƒ‡ãƒãƒƒã‚°ç”¨ã¾ãŸã¯ãƒ—ãƒ¬ãƒ¼ãƒ³ãªã‚°ãƒªãƒƒãƒ‰ã‚’è¡¨ç¤º)
            // å°†æ¥çš„ã«ã¯ã“ã“ã§ã‚¤ãƒ«ã‚«ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒ‡ãƒ¼ã‚¿ãªã©ã‚’å‚ç…§ã™ã‚‹
            let isOn = debugAllOn
            
            if (!isOn && text) {
              const char = text[cellIndex] || ' '
              const pattern = CHAR_PATTERNS[char.toUpperCase()] || CHAR_PATTERNS[' ']
              if (pattern && pattern[r] && pattern[r][c]) {
                isOn = true
              }
            } else if (!isOn) {
               isOn = Math.random() > 0.9 // ãƒ†ã‚¹ãƒˆç”¨ã«ãƒ©ãƒ³ãƒ€ãƒ ç‚¹ç¯ (fallback)
            }

            ctx.fillStyle = isOn ? color : offColor
            // æ¶ˆç¯ãƒ‰ãƒƒãƒˆã¯ç™ºå…‰ã•ã›ãªã„
            ctx.shadowBlur = isOn ? glowBlur : 0

            // ãƒ€ãƒ–ãƒ«ã‚¹ãƒ©ãƒ³ãƒˆã®æç”»ãƒ­ã‚¸ãƒƒã‚¯
            const drawX = x
            const drawY = y + pixel.height // å·¦ä¸‹åº§æ¨™

            const p4 = { x: drawX, y: drawY } // å·¦ä¸‹
            const p3 = { x: drawX + pixel.width, y: drawY - pixel.slopeTB } // å³ä¸‹
            const p1 = { x: drawX + pixel.slantLR, y: drawY - pixel.height } // å·¦ä¸Š
            const p2 = { x: drawX + pixel.width + pixel.slantLR, y: drawY - pixel.height - pixel.slopeTB } // å³ä¸Š

            ctx.beginPath()
            ctx.moveTo(p1.x, p1.y)
            ctx.lineTo(p2.x, p2.y)
            ctx.lineTo(p3.x, p3.y)
            ctx.lineTo(p4.x, p4.y)
            ctx.closePath()
            ctx.fill()
          }
        }
      }

      animationFrameId = requestAnimationFrame(render)
    }

    render()

    return () => {
      cancelAnimationFrame(animationFrameId)
    }
  }, [])

  return <canvas ref={canvasRef} width={width} height={height} className={className} />
}
